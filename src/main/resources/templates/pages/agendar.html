<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Sala - SALAS</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <!-- Estilos Personalizados -->
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
<header>
    <!-- Cabeçalho (igual em todas as páginas) -->
    <div class="navbar-top">
        <div class="container-fluid d-flex align-items-center justify-content-between">
            <div class="navbar-brand-container">
                <a class="navbar-brand" th:href="@{/home}">
                    <i class="bi bi-door-open"></i>
                </a>
            </div>
            <div class="centered-title-container text-center">
                <h1>SALAS</h1>
                <span>Agendamento</span>
            </div>
            <div class="login-section d-flex align-items-center">
                <a href="#">login</a>
                <span class="login-status-indicator"></span>
            </div>
        </div>
    </div>
    <nav class="navbar navbar-expand-lg navbar-dark navbar-bottom">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/home}">início</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" th:href="@{/agendamento/novo}">agendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/agendamento}">agendamentos</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" th:href="@{/sala}">salas</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
</header>

<main class="container my-5">
    <!-- Mensagens de Sucesso/Erro -->
    <div th:if="${mensagemSucesso}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i>
        <span th:text="${mensagemSucesso}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    <div th:if="${mensagemErro}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <span th:text="${mensagemErro}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h4 class="mb-0 text-center">
                        <i class="bi bi-calendar-plus"></i>
                        <span th:text="${agendamento.id != null} ? 'Editar Agendamento' : 'Novo Agendamento'">
                                Novo Agendamento
                            </span>
                    </h4>
                </div>
                <div class="card-body">
                    <form th:action="${agendamento.id != null} ? @{/agendamento/editar} : @{/agendamento/salvar}"
                          th:object="${agendamento}"
                          method="post">

                        <!-- Campo ID hidden para edição -->
                        <input type="hidden" th:field="*{id}" />

                        <div class="row g-4">
                            <!-- Coluna da Esquerda: Formulário -->
                            <div class="col-md-6">
                                <!-- Sala -->
                                <div class="mb-3">
                                    <label for="sala" class="form-label fw-bold">Sala*</label>
                                    <select class="form-select" th:field="*{sala.id}" id="sala" required>
                                        <option value="">Selecione uma sala...</option>
                                        <option th:each="sala : ${salas}"
                                                th:value="${sala.id}"
                                                th:text="${sala.bloco + ' - ' + sala.tipo + ' (Capacidade: ' + sala.capacidade + ')'}">
                                        </option>
                                    </select>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('sala.id')}">
                                        <span th:errors="*{sala.id}"></span>
                                    </div>
                                </div>

                                <!-- Data -->
                                <div class="mb-3">
                                    <label for="data" class="form-label fw-bold">Data*</label>
                                    <input type="date" class="form-control" th:field="*{data}" id="data"
                                           th:min="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                                           required>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('data')}">
                                        <span th:errors="*{data}"></span>
                                    </div>
                                </div>

                                <!-- Turno -->
                                <div class="mb-3">
                                    <label for="turno" class="form-label fw-bold">Turno*</label>
                                    <select class="form-select" th:field="*{turno}" id="turno" required>
                                        <option value="0">Selecione o turno...</option>
                                        <option value="1">Manhã (06:00 - 11:59)</option>
                                        <option value="2">Tarde (12:00 - 17:59)</option>
                                        <option value="3">Noite (18:00 - 23:59)</option>
                                    </select>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('turno')}">
                                        <span th:errors="*{turno}"></span>
                                    </div>
                                </div>

                                <!-- Funcionário -->
                                <div class="mb-3">
                                    <label for="funcionario" class="form-label fw-bold">Solicitante*</label>
                                    <select class="form-select" th:field="*{funcionario.id}" id="funcionario" required>
                                        <option value="">Selecione o solicitante...</option>
                                        <option th:each="funcionario : ${funcionarios}"
                                                th:value="${funcionario.id}"
                                                th:text="${funcionario.nome + ' (' + funcionario.matricula + ')'}">
                                        </option>
                                    </select>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('funcionario.id')}">
                                        <span th:errors="*{funcionario.id}"></span>
                                    </div>
                                </div>

                                <!-- Status (apenas para edição) -->
                                <div th:if="${agendamento.id != null}" class="mb-3">
                                    <label for="status" class="form-label fw-bold">Status</label>
                                    <select class="form-select" th:field="*{status}" id="status">
                                        <option value="3">Pendente</option>
                                        <option value="2">Em Andamento</option>
                                        <option value="1">Concluído</option>
                                        <option value="4">Cancelado</option>
                                    </select>
                                </div>

                                <!-- Repetição (opcional) -->
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="repeat-check">
                                    <label class="form-check-label fw-bold" for="repeat-check">
                                        Repetir agendamento semanalmente?
                                    </label>
                                </div>
                                <div id="repetition-options" class="d-none">
                                    <div class="mb-3">
                                        <label for="repeat-weeks" class="form-label">Número de semanas</label>
                                        <input type="number" class="form-control" id="repeat-weeks"
                                               min="1" max="12" value="1">
                                        <small class="form-text text-muted">O agendamento será repetido pelas próximas semanas.</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Coluna da Direita: Informações e Disponibilidade -->
                            <div class="col-md-6">
                                <div class="card bg-light border-0">
                                    <div class="card-body">
                                        <h6 class="card-title fw-bold">
                                            <i class="bi bi-info-circle"></i> Informações da Sala
                                        </h6>
                                        <div id="sala-info" class="text-muted">
                                            Selecione uma sala para ver os detalhes
                                        </div>
                                    </div>
                                </div>

                                <div class="card bg-light border-0 mt-3">
                                    <div class="card-body">
                                        <h6 class="card-title fw-bold">
                                            <i class="bi bi-calendar-check"></i> Disponibilidade
                                        </h6>
                                        <div id="disponibilidade" class="text-muted">
                                            Selecione data e turno para verificar disponibilidade
                                        </div>
                                    </div>
                                </div>

                                <!-- Calendário Simples -->
                                <div class="card bg-light border-0 mt-3">
                                    <div class="card-body">
                                        <h6 class="card-title fw-bold">
                                            <i class="bi bi-calendar3"></i> Calendário
                                        </h6>
                                        <div class="text-center">
                                            <input type="date" class="form-control" th:field="*{data}"
                                                   th:min="${#temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}"
                                                   onchange="atualizarDisponibilidade()">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="text-center mt-4">
                            <button type="submit" class="btn btn-custom-orange me-2">
                                <i class="bi bi-calendar-check"></i>
                                <span th:text="${agendamento.id != null} ? 'ATUALIZAR' : 'AGENDAR'">AGENDAR</span>
                            </button>
                            <a th:href="@{/agendamento}" class="btn btn-custom-blue">
                                <i class="bi bi-arrow-left"></i> VOLTAR
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Controle da repetição
        document.getElementById('repeat-check').addEventListener('change', function() {
            const repetitionOptions = document.getElementById('repetition-options');
            if (this.checked) {
                repetitionOptions.classList.remove('d-none');
            } else {
                repetitionOptions.classList.add('d-none');
            }
        });

        // Atualizar informações da sala
        document.getElementById('sala').addEventListener('change', function() {
            atualizarInfoSala(this.value);
        });

        // Atualizar disponibilidade quando dados mudarem
        document.getElementById('sala').addEventListener('change', atualizarDisponibilidade);
        document.getElementById('data').addEventListener('change', atualizarDisponibilidade);
        document.getElementById('turno').addEventListener('change', atualizarDisponibilidade);

        // Validação do formulário
        const form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        });
    });

    function atualizarInfoSala(salaId) {
        const salaInfo = document.getElementById('sala-info');
        if (!salaId) {
            salaInfo.innerHTML = '<span class="text-muted">Selecione uma sala para ver os detalhes</span>';
            return;
        }

        // Simulação - na implementação real, isso viria do backend
        const salas = {
            '1': { bloco: 'A', tipo: 'Sala de Aula', capacidade: 30, recursos: 'Projetor, Wi-Fi' },
            '2': { bloco: 'A', tipo: 'Laboratório', capacidade: 20, recursos: 'Computadores, Projetor' },
            '3': { bloco: 'B', tipo: 'Auditório', capacidade: 100, recursos: 'Projetor, Som, Ar-condicionado' }
        };

        const sala = salas[salaId];
        if (sala) {
            salaInfo.innerHTML = `
                    <div class="fw-bold">${sala.bloco} - ${sala.tipo}</div>
                    <div>Capacidade: ${sala.capacidade} pessoas</div>
                    <div>Recursos: ${sala.recursos}</div>
                `;
        }
    }

    function atualizarDisponibilidade() {
        const salaId = document.getElementById('sala').value;
        const data = document.getElementById('data').value;
        const turno = document.getElementById('turno').value;
        const disponibilidade = document.getElementById('disponibilidade');

        if (!salaId || !data || !turno) {
            disponibilidade.innerHTML = '<span class="text-muted">Selecione data e turno para verificar disponibilidade</span>';
            return;
        }

        // Simulação de verificação de disponibilidade
        const turnos = {
            '1': 'Manhã',
            '2': 'Tarde',
            '3': 'Noite'
        };

        // Simulação - na implementação real, isso viria de uma chamada AJAX
        setTimeout(() => {
            const disponivel = Math.random() > 0.3; // 70% de chance de estar disponível

            if (disponivel) {
                disponibilidade.innerHTML = `
                        <div class="text-success fw-bold">
                            <i class="bi bi-check-circle"></i> Sala disponível no turno da ${turnos[turno]}
                        </div>
                        <small class="text-muted">Pode prosseguir com o agendamento</small>
                    `;
            } else {
                disponibilidade.innerHTML = `
                        <div class="text-danger fw-bold">
                            <i class="bi bi-x-circle"></i> Sala indisponível no turno da ${turnos[turno]}
                        </div>
                        <small class="text-muted">Selecione outra data, turno ou sala</small>
                    `;
            }
        }, 500);
    }

    // Inicializar informações iniciais
    const salaInicial = document.getElementById('sala').value;
    if (salaInicial) {
        atualizarInfoSala(salaInicial);
    }
</script>
</body>
</html>